FROM rust:latest as builder


# RUN apt
RUN apt-get update -y
RUN apt-get install musl-tools -y
RUN rustup target add x86_64-unknown-linux-musl
# RUN

WORKDIR /app

COPY auth/Cargo.toml auth/Cargo.lock ./auth/
COPY common_service/Cargo.toml common_service/Cargo.lock ./common_service/

# COPY common_service/ ./common_service/

WORKDIR /app/common_service
RUN mkdir src && echo "" > src/lib.rs

WORKDIR /app/auth
RUN mkdir src && echo "fn main() {}" > src/main.rs


RUN cargo build --release

WORKDIR /app
COPY auth/src ./auth/src
COPY common_service/src ./common_service/src

WORKDIR /app/auth

# remove the dummy binary(created for installing dependencies and caching purpose)
# to force a rebuild with the actual code
# RUN rm -rf target/x86_64-unknown-linux-musl/release/auth*

RUN cargo build --release --target x86_64-unknown-linux-musl

FROM scratch

COPY --from=builder /app/auth/target/x86_64-unknown-linux-musl/release/auth /auth
COPY auth/.env /.env

# EXPOSE 9988
CMD ["/auth"]
